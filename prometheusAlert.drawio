<mxfile host="app.diagrams.net" modified="2021-03-22T10:40:17.072Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36" etag="Go1CD-ehzB_TDHmdUmSc" version="14.4.4" type="github">
  <diagram id="k6DoNazx9PnfbwAKResi" name="Page-1">
    <mxGraphModel dx="2249" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="E3SrIeCULbJYvBl_LrCa-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="E3SrIeCULbJYvBl_LrCa-1" target="E3SrIeCULbJYvBl_LrCa-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-1" value="prometheus" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="112" y="200" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-2" value="jarvis soa" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="90" y="20" width="180" height="70" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="E3SrIeCULbJYvBl_LrCa-3" target="E3SrIeCULbJYvBl_LrCa-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-3" value="admin port metrics" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="104" y="70" width="156" height="40" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="E3SrIeCULbJYvBl_LrCa-4" target="E3SrIeCULbJYvBl_LrCa-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-4" value="prometheus Alert" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="112" y="360" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-5" value="jarvisx alert web" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="112" y="570" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-8" value="&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;api_request_counter_new&lt;/pre&gt;&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;api_request_error_counter_new&lt;/pre&gt;&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;api_request_cost_time_new&lt;/pre&gt;&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;&lt;pre style=&quot;overflow-wrap: break-word&quot;&gt;&lt;b&gt;api_request_max_time_new&lt;/b&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=#ffffff;labelBorderColor=#000000;spacing=2;labelPosition=center;verticalLabelPosition=middle;textDirection=rtl;" vertex="1" parent="1">
          <mxGeometry x="300" y="20" width="190" height="90" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-9" value="&lt;pre style=&quot;color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; text-indent: 0px; text-transform: none; word-spacing: 0px; overflow-wrap: break-word;&quot;&gt;api_request_counter_new{host=&quot;newtest.jarvis-api.oa.com&quot;,serviceGroup=&quot;default&quot;,serviceName=&quot;FMKTService&quot;,version=&quot;1.0&quot;,methodName=&quot;getProjectFinishCash&quot;,providerId=&quot;24350&quot;,providerName=&quot;财经立项管理系统&quot;,clientId=&quot;63545&quot;,clientName=&quot;AMS内容中台&quot;,} 2.0&lt;/pre&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="500" width="1540" height="50" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-10" value="&lt;pre style=&quot;color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; text-indent: 0px; text-transform: none; word-spacing: 0px; overflow-wrap: break-word;&quot;&gt;api_request_error_counter_new{host=&quot;newtest.jarvis-api.oa.com&quot;,serviceGroup=&quot;default&quot;,serviceName=&quot;Datasync&quot;,version=&quot;1.0&quot;,methodName=&quot;get&quot;,providerId=&quot;30991&quot;,providerName=&quot;Jarvis门户&quot;,clientId=&quot;20020&quot;,clientName=&quot;jarvis-datasync&quot;,} 2.0&lt;/pre&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="30" width="1530" height="50" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-11" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; font-style: normal ; font-weight: 400 ; letter-spacing: normal ; text-indent: 0px ; text-transform: none ; word-spacing: 0px ; overflow-wrap: break-word&quot;&gt;api_request_cost_time_new{host=&quot;newtest.jarvis-api.oa.com&quot;,serviceGroup=&quot;default&quot;,serviceName=&quot;FMKTService&quot;,version=&quot;1.0&quot;,methodName=&quot;getProjectFinishCash&quot;,providerId=&quot;24350&quot;,providerName=&quot;财经立项管理系统&quot;,clientId=&quot;63545&quot;,clientName=&quot;AMS内容中台&quot;,} 0.023945768&lt;/pre&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="55" width="1750" height="70" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-12" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; font-style: normal ; letter-spacing: normal ; text-indent: 0px ; text-transform: none ; word-spacing: 0px ; overflow-wrap: break-word&quot;&gt;&lt;b&gt;api_request_max_time_new{traceId=&quot;267023676694593568&quot;,host=&quot;newtest.jarvis-api.oa.com&quot;,serviceGroup=&quot;default&quot;,serviceName=&quot;Datasync&quot;,version=&quot;1.0&quot;,methodName=&quot;post&quot;,providerId=&quot;30991&quot;,providerName=&quot;Jarvis门户&quot;,clientId=&quot;20020&quot;,clientName=&quot;jarvis-datasync&quot;,startTime=&quot;1616407364&quot;,maxTime=&quot;10&quot;,receiver=&quot;kyleleeli;kyleleeli&quot;,} 1.616407374E9&lt;/b&gt;&lt;/pre&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="80" width="2390" height="50" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-16" value="&lt;div&gt;#https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook&lt;/div&gt;&lt;div&gt;global:&lt;/div&gt;&lt;div&gt;&amp;nbsp; resolve_timeout: 5m&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; #该参数定义了当Alertmanager持续多长时间未接收到告警后标记告警状态为resolved（已解决)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#用于定义告警通知时的模板，如HTML模板，邮件模板等&lt;/div&gt;&lt;div&gt;#templates:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#根据标签匹配，确定当前告警应该如何处理&lt;/div&gt;&lt;div&gt;route:&lt;/div&gt;&lt;div&gt;&amp;nbsp; #通过标签进行聚合&lt;/div&gt;&lt;div&gt;&amp;nbsp; group_by: [&#39;alertname&#39;,&quot;traceId&quot;]&lt;/div&gt;&lt;div&gt;&amp;nbsp; group_wait: 0s&lt;/div&gt;&lt;div&gt;&amp;nbsp; # 相同分组之间的告警频率的设置&lt;/div&gt;&lt;div&gt;&amp;nbsp; group_interval: 1s&lt;/div&gt;&lt;div&gt;&amp;nbsp; #告警信息已经发送成功后，再次被触发发送的时间间隔&lt;/div&gt;&lt;div&gt;&amp;nbsp; repeat_interval: 1h&lt;/div&gt;&lt;div&gt;&amp;nbsp; receiver: &#39;web.hook&#39;&lt;/div&gt;&lt;div&gt;#&amp;nbsp; routes:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; - receiver: &#39;database-pager&#39;&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; group_wait: 10s&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; match_re:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; &amp;nbsp; service: mysql|cassandra&lt;/div&gt;&lt;div&gt;#&amp;nbsp; - receiver: &#39;frontend-pager&#39;&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; group_by: [product, environment]&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; match:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; &amp;nbsp; team: frontend&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# 没有设置子路由配置&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#接收人是一个抽象的概念，它可以是一个邮箱也可以是微信，Slack或者Webhook等，接收人一般配合告警路由使用&lt;/div&gt;&lt;div&gt;receivers:&lt;/div&gt;&lt;div&gt;- name: &#39;web.hook&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; webhook_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; #指定是否在告警消除时发送回执消息&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; - send_resolved: false&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; url: &#39;http://9.134.119.94:18834/api/webhook&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;#合理设置抑制规则可以减少垃圾告警的产生&lt;/div&gt;&lt;div&gt;#inhibit_rules:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; - source_match:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; &amp;nbsp; severity: &#39;critical&#39;&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; target_match:&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; &amp;nbsp; severity: &#39;warning&#39;&lt;/div&gt;&lt;div&gt;#&amp;nbsp; &amp;nbsp; equal: [&#39;alertname&#39;, &#39;dev&#39;, &#39;instance&#39;]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-20" y="660" width="680" height="645" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-17" value="&lt;div&gt;# my global config&lt;/div&gt;&lt;div&gt;global:&lt;/div&gt;&lt;div&gt;&amp;nbsp; scrape_interval:&amp;nbsp; &amp;nbsp; &amp;nbsp;1s # Set the scrape interval to every 15 seconds. Default is every 1 minute.&lt;/div&gt;&lt;div&gt;&amp;nbsp; evaluation_interval: 1s # Evaluate rules every 15 seconds. The default is every 1 minute.&lt;/div&gt;&lt;div&gt;&amp;nbsp; # scrape_timeout is set to the global default (10s).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# Alertmanager configuration&lt;/div&gt;&lt;div&gt;alerting:&lt;/div&gt;&lt;div&gt;&amp;nbsp; alertmanagers:&lt;/div&gt;&lt;div&gt;&amp;nbsp; - static_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; - targets:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;- localhost:9093&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.&lt;/div&gt;&lt;div&gt;rule_files:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;- &quot;first_rules.yml&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;- &quot;api_rules.yml&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# A scrape configuration containing exactly one endpoint to scrape:&lt;/div&gt;&lt;div&gt;# Here it&#39;s Prometheus itself.&lt;/div&gt;&lt;div&gt;scrape_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; # The job name is added as a label `job=&amp;lt;job_name&amp;gt;` to any timeseries scraped from this config.&lt;/div&gt;&lt;div&gt;&amp;nbsp; - job_name: &#39;prometheus&#39;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; # metrics_path defaults to &#39;/metrics&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; # scheme defaults to &#39;http&#39;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; - targets: [&#39;localhost:9090&#39;]&lt;/div&gt;&lt;div&gt;&amp;nbsp; - job_name: &#39;jarvisx-leaf&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; scrape_interval: 1s&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; metrics_path: &#39;/admin/prometheus&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; - targets: [&#39;9.134.119.94:19834&#39;]&lt;/div&gt;&lt;div&gt;&amp;nbsp; - job_name: &#39;jarvis-soa&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; scrape_interval: 1s&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; metrics_path: &#39;/admin/prometheus&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static_configs:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; - targets: [&#39;9.135.98.152:31218&#39;]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="650" y="170" width="990" height="590" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-18" value="&lt;div&gt;groups:&lt;/div&gt;&lt;div&gt;- name: api Rule&lt;/div&gt;&lt;div&gt;&amp;nbsp; rules:&lt;/div&gt;&lt;div&gt;&amp;nbsp; - alert: api request max time out&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; expr: api_request_max_time_new &amp;lt; time()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; # 评估等待时间，可选参数。用于表示只有当触发条件持续一段时间后才发送告警。在等待期间新产生告警的状态为pending&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; #for: 1s&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; #自定义标签，允许用户指定要附加到告警上的一组附加标签&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; labels:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; type: api&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; annotations:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; summary: 【API 预期超时告警】{{ $labels.host }}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; description:&amp;nbsp; host:{{ $labels.host }} \n ;instance:{{ $labels.instance }} \n ;traceId:{{ $labels.traceId }} \n ;serviceGroup:{{ $labels.serviceGroup }} \n ;serviceName:{{ $labels.serviceName }} \n ;version:{{ $labels.version }} \n ;methodName:{{ $labels.methodName }} \n ;providerId:{{ $labels.providerId }} \n ;providerName:{{ $labels.providerName }} \n ;clientId:{{ $labels.clientId }} \n ;clientName:{{ $labels.clientName }} \n ;startTime:{{ $labels.startTime }} \n ;maxTime:{{ $labels.maxTime }} \n ;receiver:{{ $labels.receiver }} \n ;value:{{ $value }}&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="660" y="750" width="620" height="260" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-19" value="&lt;span&gt;global.&lt;/span&gt;scrape_interval: 1s&lt;br&gt;global.evaluation_interval: 1s&lt;br&gt;&lt;br&gt;alerting:&lt;br&gt;rule_files:&lt;br&gt;scrape_configs:&lt;br&gt;&lt;br&gt;&amp;nbsp;expr: api_request_max_time_new &amp;lt; time()" style="rounded=0;whiteSpace=wrap;html=1;align=left;gradientColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="280" y="170" width="300" height="120" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-20" value="&lt;div&gt;receivers:&lt;/div&gt;&lt;div&gt;- name: &#39;web.hook&#39;&lt;/div&gt;&lt;div&gt;&amp;nbsp; webhook_configs:&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="280" y="365" width="300" height="50" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-21" value="tof alert service" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="280" y="580" width="300" height="50" as="geometry" />
        </mxCell>
        <mxCell id="E3SrIeCULbJYvBl_LrCa-24" value="&lt;h1&gt;总结&lt;/h1&gt;&lt;p&gt;超时告警规则限制&lt;/p&gt;&lt;p&gt;1.prometheus 抓取时间1s&lt;/p&gt;&lt;p&gt;2.prometheus 规则评估时间1s&lt;/p&gt;&lt;p&gt;3.消息告警推送延迟wx 邮件&lt;/p&gt;&lt;p&gt;4.聚合推送问题（hold 关闭）for注意&lt;/p&gt;&lt;p&gt;理论上【2s】 超时以上才能超时告警&lt;/p&gt;&lt;p&gt;所以一般监控耗时接口 请求才有用&lt;/p&gt;&lt;p&gt;超时补充&lt;/p&gt;&lt;p&gt;nginx 超时&lt;/p&gt;&lt;p&gt;soa web容器 http链接超时&lt;/p&gt;&lt;p&gt;rpc invoke 超时&lt;/p&gt;" style="text;html=1;strokeColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;labelBackgroundColor=none;align=left;fillColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="660" y="1030" width="270" height="330" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
